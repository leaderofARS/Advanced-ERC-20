name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    name: Scan for secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for .env files
        run: |
          if git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$"; then
            echo "❌ ERROR: .env files found in repository!"
            echo "These files should not be committed."
            exit 1
          else
            echo "✅ No .env files found in repository"
          fi

      - name: Check for common secret patterns
        run: |
          echo "Scanning for potential secrets..."
          
          # Check for API keys
          if git diff-tree --no-commit-id --name-only -r HEAD | xargs grep -l "AKIA[0-9A-Z]{16}" 2>/dev/null; then
            echo "❌ Potential AWS API key found!"
            exit 1
          fi
          
          # Check for private keys
          if git diff-tree --no-commit-id --name-only -r HEAD | xargs grep -l "BEGIN.*PRIVATE KEY" 2>/dev/null; then
            echo "❌ Private key found!"
            exit 1
          fi
          
          echo "✅ No obvious secrets detected"

      - name: Verify .gitignore
        run: |
          if [ ! -f .gitignore ]; then
            echo "❌ .gitignore file missing!"
            exit 1
          fi
          
          if ! grep -q "^\.env$" .gitignore; then
            echo "❌ .gitignore doesn't protect .env files!"
            exit 1
          fi
          
          echo "✅ .gitignore properly configured"

      - name: Check for hardcoded secrets in code
        run: |
          echo "Checking for hardcoded secrets..."
          
          # Patterns to avoid
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
          )
          
          for pattern in "${PATTERNS[@]}"; do
            if git diff-tree --no-commit-id --name-only -r HEAD | xargs grep -E "$pattern" 2>/dev/null; then
              echo "⚠️  Warning: Potential hardcoded secret found"
              echo "Please use environment variables instead"
            fi
          done
          
          echo "✅ Hardcoded secret check complete"
